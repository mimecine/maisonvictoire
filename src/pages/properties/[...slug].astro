---
import {
  type CollectionEntry,
  getCollection,
  getEntry,
  render,
} from "astro:content";
import { Image } from "astro:assets";
import Main from "@src/layouts/Main.astro";
import { Icon } from "astro-icon/components";
import Thumbnail from "@src/components/Thumbnail.astro";
import FormattedDate from "@src/components/FormattedDate.astro";
import Video from "@src/components/Video.astro";
import { getEntries } from "astro:content";

const PriceFmt = new Intl.NumberFormat("en-GB", {
  style: "currency",
  currency: "EUR",
  maximumFractionDigits: 0,
});

type Props = CollectionEntry<"properties">;

export async function getStaticPaths() {
  let properties = await getCollection("properties");
  return properties
    .filter((property) => property.data.draft !== true)
    .map((property) => ({
      params: { slug: property.id },
      props: property,
    }));
}

const property = Astro.props;

const { Content } = await render(property);
---

<Main
  title={`Maison Victoire - ${property.data.city} - ${property.data.reference}`}
  heading={property.data.city}
  description={property.data.summary}
  x-data="{ open: false, planopen: false }">
  <main class="" data-city={property.data.city}>
    <span class="hidden" data-pagefind-meta="title" data-pagefind-weight="20"
      >property: {property.data.title}</span
    >
    <section>
      <div class="flex flex-wrap pb-12">
        <div class="md:w-1/2">
          <Image
            width={property.data.images?.[0].width}
            height={property.data.images?.[0].height}
            widths={[480, property.data.images?.[0].width]}
            sizes={`(max-width: 480px) 480px, ${property.data.images?.[0].width}px`}
            src={property.data.images?.[0]}
            alt={property.data.title}
            loading="eager"
            class="mx-auto mb-4 p-2 bg-gray-200 max-w-full w-auto object-cover opacity-0 transition-opacity duration-500 max-h-[80vh]"
            onload="this.classList.remove('opacity-0')"
          />

          <div class="flex flex-wrap gap-4 px-2 text-lg font-thin">
            <div class="flex items-center gap-2">
              <span>{property.data.living_area} m<sup>2 </sup>,</span>
            </div>
            {property.data.status == "available" && <div class="flex items-center gap-2">
              <span
                >{
                  property.data.price
                    ? PriceFmt.format(property.data.price)
                    : "Price upon request"
                },
              </span>
            </div>}
            <div class="flex items-center gap-2">
              <span>Bedrooms: {property.data.rooms}</span>,
            </div>
            <div class="flex items-center gap-2">
              <span>Bathrooms: {property.data.baths} </span>
            </div>
            <div class="flex items-center gap-2">
              <span
                >Land: {property.data.land_area}
                {property.data.land_area > 50 ? "m²" : "ha"}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <span>Reference: {property.data.reference}</span>
            </div>
          </div>
          <div>
            {
              property.data.summary && (
                <p class="py-8 text-6xl font-thin">{property.data.summary}</p>
              )
            }
          </div>
        </div>
        <div class="md:w-1/2 md:px-4 mt-2 font-light grid grid-rows[auto_1fr] gap-6 print:break-before-page print:py-12 px-8">
          <div class="prose max-w-none">
          <Content />
          </div>
          <div class="w-full text-right text-3xl font-thin print:hidden"><a class="border-b" href={`mailto:client@maisonvictoire.com?subject=Inquiry:%20${property.data.reference}%20-%20${property.data.city}`} target="email"> Inquire about this property</a></div>
          <div class="hidden print:block text-center text-2xl font-thin">To inquire about this property, please send an email to <span class="italic">client@maisonvictoire.com</span> or call <span class="italic">+352 26 27 19 59</span> and provide us with the reference: <span class="italic">{property.data.reference}</span></div>
        </div>
      </div>

      <div>
        <ul
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 print:grid-cols-2 print:p-8 gap-6 justify-between">
          {
            property.data.images?.map((img, index) => (
              <li
                class="cursor-pointer relative"
                x-data={`{slide:'slide${index}'}`}
                @click="$refs.dialog.showModal();$refs[slide].scrollIntoView({behavior:'instant'}); open=!open;">
                
                  <Thumbnail
                    src={img}
                    alt={property.data.title}
                    title={property.data.title}
                    loading="lazy"
                  />
                
              </li>
            ))
          }
        </ul>

        <ul class="grid lg:grid-cols-2 print:grid-cols-1 gap-6 justify-between pt-8 break-before-page">
          {
            property.data.floorplans?.map((img, index) => (
              <li class="cursor-pointer relative"
              x-data={`{plan:'plan${index}'}`}
                @click="$refs.plandialog.showModal();$refs[plan].scrollIntoView({behavior:'instant'}); planopen=!planopen;">
                <Image
                  src={img}
                  alt={property.data.title}
                  title={property.data.title}
                  loading="lazy"
                />
              </li>
            ))
          }
        </ul>
        <ul class="grid grid-cols-1 gap-6 justify-between pt-8  print:hidden ">
          {
            property.data.videos?.map((video, index) => (
              <li class="cursor-pointer relative">
                <iframe 
                  src={video}
                  title={`Video tour ${property.data.title}`}
                  class="w-full aspect-video"
                  loading="lazy"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                ></iframe>
              </li>
            ))
          }
        </ul>

        <div class="hidden print:block break-before-page">
          <h2 class="text-2xl font-thin mt-12 mb-4">Property Details</h2>
          <table class="w-full table-auto border-collapse border border-gray-400 columns-2">
            <tbody>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Total rooms
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  10
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Bedrooms
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  5
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Bathrooms
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  7
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Pool
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  30m2 heated saltwater pool with safety cover
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Parking spaces
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  4
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Heating
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  Reversible heat pump, underfloor, and radiators
                </td>
              </tr>
              <tr>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                  Property tax
                </td>
                <td class="border border-gray-400 px-2 py-1 font-light text-sm italic">
                  789 €
                </td>
              </tr>
            </tbody>

            <!-- <tbody>
              {
                Object.entries(property.data.technical_details || {}).map(
                  ([key, value]) => (
                    <tr class="border border-gray-400">
                      <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                        {key.replaceAll("_", " ")}
                      </td>
                      <td class="border border-gray-400 px-2 py-1 font-light text-sm">
                        {value}
                      </td>
                    </tr>
                  )
                )
              }
            </tbody> -->
          </table>
          
        </div>

        <dialog
          id="dialog"
          x-ref="dialog"
          @keydown.escape.window="$refs.dialog.close(); open=!open;"
          class="w-screen h-screen m-auto inset-0 z-600 opacity-0 pointer-events-none transition-opacity duration-500 open:opacity-100 open:pointer-events-auto bg-gray-100 backdrop:bg-gray-800/60"
          role="dialog"
          aria-modal="true">
          <div
            x-ref="slider"
            @scrollend="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider;$refs.button_prev.classList.toggle('opacity-10',scrollLeft === 0); $refs.button_next.classList.toggle('opacity-10',scrollLeft+clientWidth === scrollWidth);"
            class="flex overflow-x-scroll items-start h-full snap-x snap-mandatory scroll-smooth select-text focus-visible:outline-hidden scrollbar-hide">
            <button
              @click="$refs.dialog.close(); open=!open;"
              class="absolute leading-none right-2 top-2 p-28 pr-0 pt-0 focus-visible:outline-hidden z-10"
              ><Icon
                name="material-symbols-light:close-rounded"
                class="size-12 lg:size-12"
              /></button
            >
            <button
              x-ref="button_prev"
              @click="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider;  $refs.slider.scrollBy({left: -clientWidth, behavior:'smooth'});"
              @keyup.left.window="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider; $refs.slider.scrollBy({left: -clientWidth, behavior:'smooth'});"
              class="absolute left-0 top-[30vh] bottom-[30vh] mt-auto p-28 pl-2 leading-none focus-visible:outline-hidden z-10 opacity-10 invisible md:visible"
              ><Icon
                name="material-symbols-light:arrow-back-ios-rounded"
                class="size-8 lg:size-8"
              /></button
            >
            <button
              x-ref="button_next"
              @click="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider; $refs.slider.scrollBy({left: clientWidth, behavior:'smooth'});"
              @keyup.right.window="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider; $refs.slider.scrollBy({left: clientWidth, behavior:'smooth'});"
              class="absolute right-0 top-[30vh] bottom-[30vh] mt-auto p-28 pr-0 leading-none focus-visible:outline-hidden z-10 invisible md:visible"
              ><Icon
                name="material-symbols-light:arrow-forward-ios-rounded"
                class="size-8 lg:size-8"
              /></button
            >

            {
              property.data.images?.map((img, _i) => (
                <div
                  x-ref={`slide${_i}`}
                  id={`slide${_i}`}
                  class="relative flex-none w-full h-full p-2 grid grid-rows-[1fr_auto_auto] items-center justify-center snap-x snap-center text-sm font-thin">
                  <div class="w-full h-[80vh] items-center content-center justify-center bg-no-repeat bg-center bg-[url('/SvgSpinners180RingWithBg.svg')]">
                    <Image
                      src={img}
                      alt={property.data.title}
                      widths={[360, img.width]}
                      sizes={`(max-width: 360px) 360px, ${img.width}px`}
                      x-widths={[360, 1600]}
                      x-sizes={`(max-width: 360px) 360px, ${img.width}px`}
                      class="object-contain max-w-full max-h-full transition-opacity duration-500 opacity-0" 
                      onload="this.classList.remove('opacity-0')"
                    />
                  </div>
                  <div class="absolute bottom-0 p-2 items-center justify-evenly w-full grid md:grid-flow-col gap-x-8"></div>
                </div>
              ))
            }
          </div>
        </dialog>
        <dialog
          id="plandialog"
          x-ref="plandialog"
          @keydown.escape.window="$refs.plandialog.close(); planopen=!planopen;"
          class="w-screen h-screen m-auto inset-0 z-600 opacity-0 pointer-events-none transition-opacity duration-500 open:opacity-100 open:pointer-events-auto bg-gray-100 backdrop:bg-gray-800/60"
          role="dialog"
          aria-modal="true">
          <div
            x-ref="planslider"
            @scrollend="let {scrollLeft, clientWidth, scrollWidth} = $refs.planslider;$refs.plan_button_prev.classList.toggle('opacity-10',scrollLeft === 0); $refs.plan_button_next.classList.toggle('opacity-10',scrollLeft+clientWidth === scrollWidth);"
            class="flex overflow-x-scroll items-start h-full snap-x snap-mandatory scroll-smooth select-text focus-visible:outline-hidden scrollbar-hide">
            <button
              @click="$refs.plandialog.close(); planopen=!planopen;"
              class="absolute leading-none right-2 top-2 p-28 pr-0 pt-0 focus-visible:outline-hidden z-10"
              ><Icon
                name="material-symbols-light:close-rounded"
                class="size-12 lg:size-12"
              /></button
            >
            <button
              x-ref="plan_button_prev"
              @click="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider;  $refs.slider.scrollBy({left: -clientWidth, behavior:'smooth'});"
              @keyup.left.window="let {scrollLeft, clientWidth, scrollWidth} = $refs.slider; $refs.slider.scrollBy({left: -clientWidth, behavior:'smooth'});"
              class="absolute left-0 top-[30vh] bottom-[30vh] mt-auto p-28 pl-2 leading-none focus-visible:outline-hidden z-10 opacity-10 invisible md:visible"
              ><Icon
                name="material-symbols-light:arrow-back-ios-rounded"
                class="size-8 lg:size-8"
              /></button
            >
            <button
              x-ref="plan_button_next"
              @click="let {scrollLeft, clientWidth, scrollWidth} = $refs.planslider; $refs.planslider.scrollBy({left: clientWidth, behavior:'smooth'});"
              @keyup.right.window="let {scrollLeft, clientWidth, scrollWidth} = $refs.planslider; $refs.planslider.scrollBy({left: clientWidth, behavior:'smooth'});"
              class="absolute right-0 top-[30vh] bottom-[30vh] mt-auto p-28 pr-0 leading-none focus-visible:outline-hidden z-10 invisible md:visible"
              ><Icon
                name="material-symbols-light:arrow-forward-ios-rounded"
                class="size-8 lg:size-8"
              /></button
            >

            {
              property.data.floorplans?.map((img, _i) => (
                <div
                  x-ref={`plan${_i}`}
                  id={`plan${_i}`}
                  class="relative flex-none w-full h-full p-2 grid grid-rows-[1fr_auto_auto] items-center justify-center snap-x snap-center text-sm font-thin">
                  <div class="w-full h-[80vh] items-center content-center justify-center bg-no-repeat bg-center bg-[url('/SvgSpinners180RingWithBg.svg')]">
                    <Image
                      src={img}
                      alt={property.data.title}
                      widths={[360, img.width]}
                      sizes={`(max-width: 360px) 360px, ${img.width}px`}
                      x-widths={[360, 1600]}
                      x-sizes={`(max-width: 360px) 360px, ${img.width}px`}
                      class="object-contain max-w-full max-h-full transition-opacity duration-500 opacity-0" 
                      onload="this.classList.remove('opacity-0')"
                    />
                  </div>
                  <div class="absolute bottom-0 p-2 items-center justify-evenly w-full grid md:grid-flow-col gap-x-8"></div>
                </div>
              ))
            }
          </div>
        </dialog>
      </div>
    </section>
  </main>
</Main>
