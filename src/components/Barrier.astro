---
const { password, days = 7 ,  ...attrs } = Astro.props;
---
<div id="password-overlay">
  <h2>Enter password</h2>
  <form id="pw-form">
    <input id="pw-input" type="password" />
    <button id="pw-btn" type="submit">Submit</button>
  </form>
  <p id="pw-error">Wrong password</p>
</div>
<a id="logout-link" href="#">Logout</a>

<script define:vars={{password, days}} data-astro-rerun>
  
  const PASSWORD = password; // change this
  const COOKIE_NAME = "access_granted";
  const COOKIE_DAYS = days; // days until cookie expires. (1/24 = 1 hour)
  console.log("Barrier loaded with password", password, days);

  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (COOKIE_DAYS*24*60*60*1000));
    document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
  }

  function getCookie(name) {
    return document.cookie.split('; ').find(r => r.startsWith(name+"="))?.split('=')[1];
  }

  function deleteCookie(name) {
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
  }

  const overlay = document.getElementById("password-overlay");
  const logoutLink = document.getElementById("logout-link");
  const passwordField = document.getElementById("pw-input");

  // On load: check cookie
  if (getCookie(COOKIE_NAME) === "true") {
    overlay.style.display = "none";
    logoutLink.style.display = "inline-block";
  }
  document.addEventListener("astro:page-load", () => {
    console.log("page load event", getCookie(COOKIE_NAME));
    if (getCookie(COOKIE_NAME) === "true") {
      console.log("hiding overlay");
      overlay.style.display = "none";
      console.log("showing logout");
      logoutLink.style.display = "inline-block";
    } else {
      console.log("showing overlay");
      passwordField.focus();
    }
  });
  

  function handleLogin() {
    const pw = document.getElementById("pw-input").value;
    if (pw === PASSWORD) {
      setCookie(COOKIE_NAME, "true", COOKIE_DAYS);
      overlay.style.display = "none";
      logoutLink.style.display = "inline-block";
    } else {
      document.getElementById("pw-error").style.display = "block";
    }
  }

  // Handle form submission
  document.getElementById("pw-form").addEventListener("submit", (e) => {
    e.preventDefault();
    handleLogin();
  });

  // Handle logout
  logoutLink.addEventListener("click", (e) => {
    e.preventDefault();
    deleteCookie(COOKIE_NAME);
    overlay.style.display = "flex";
    logoutLink.style.display = "none";
  });
</script>

<style>
  #password-overlay {
    position: fixed;
    inset: 0;
    background: #111;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  #pw-input {
    padding: 0.5em;
    margin: 1em;
    font-size: 1em;
    background: #eee;
    color: #222;
    border: 1px solid #8c8a8a;
  }

  #pw-btn {
    padding: 0.5em 1em;
    font-size: 1em;
    /* border: 1px solid #8c8a8a; */
    background: #222;
    color: white;
    cursor: pointer;
  }

  #pw-error {
    color: tomato;
    display: none;
  }

  #logout-link {
    position: fixed;
    top: 2px;
    right: 2px;
    color: #fff;
    background: #333;
    padding: 0.2em 0.4em;
    border-radius: 0px;
    text-decoration: none;
    display: none;
    z-index: 10000;
    font-size: 0.7em;
  }

  #pw-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1em;
  }
</style>




